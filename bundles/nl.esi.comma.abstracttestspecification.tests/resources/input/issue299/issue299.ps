import "issue299.types"
specification issue299
{
    system Issue299C2ComposeJobA
    {
        inputs
        JobA	jobA
        
        outputs
        InputJobA		job_a_input
    
        local
        
        UNIT	Event_0ww9k8j
    
        // init
    
    
        desc "Issue299C2Compose Job A_Model"
        
        action			ComposeA
        element-label	"Compose A"
        case			default step-type "null" action-type COMPOSE
        with-inputs		jobA
        produces-outputs	Event_0ww9k8j suppress
        produces-outputs	job_a_input symbolic-link
        updates:
            job_a_input := InputJobA { job_id = jobA.job_id }
    
        element-labels ["Issue299", "C2", "Compose Job A"]
    }
    
    system Issue299C2RunJobA
    {
        inputs
        InputJobA	job_a_input
        
        outputs
        ReportJobA		job_a_report
    
        local
        
        UNIT	Event_0t40etv
    
        // init
    
    
        desc "Issue299C2Run Job A_Model"
        
        action			RunA
        element-label	"Run A"
        case			default step-type "JobA" action-type RUN
        with-inputs		job_a_input
        produces-outputs	Event_0t40etv suppress
        produces-outputs	job_a_report symbolic-link
        updates:
            job_a_report := ReportJobA { job_id = job_a_input.job_id }
    
        element-labels ["Issue299", "C2", "Run Job A"]
    }
    
    system Issue299C3ComposeJobB
    {
        inputs
        ReportJobA	job_a_report
        JobB	jobB
        
        outputs
        InputJobB		job_b_input
    
        local
        TempInputJobB	temp_job_b_input
        ContextComposeJobB	Gateway_0uysc4w
        
        ContextComposeJobB	Event_1880doa
    
        // init
    
    
        desc "Issue299C3Compose Job B_Model"
        
        action			FinishcomposingjobB
        element-label	"Finish composing job B"
        case			default step-type "null" action-type COMPOSE
        with-inputs		Gateway_0uysc4w, temp_job_b_input
        with-guard		Gateway_0uysc4w.iteration_index > Gateway_0uysc4w.job.count
        and
        temp_job_b_input.input.job_id == Gateway_0uysc4w.job.job_id
        produces-outputs	Event_1880doa
        updates:
            Event_1880doa := Gateway_0uysc4w
        produces-outputs	job_b_input
        references {
            x0: job_b_input.list_of_key_value_pairs := temp_job_b_input.input.list_of_key_value_pairs
        } symbolic-link
        updates:
            job_b_input := temp_job_b_input.input
        
        action			AddjobAreport
        element-label	"Add job A report"
        case			default step-type "null" action-type COMPOSE
        with-inputs		Gateway_0uysc4w, job_a_report, temp_job_b_input
        with-guard		Gateway_0uysc4w.iteration_index <= Gateway_0uysc4w.job.count
        and
        temp_job_b_input.input.job_id == Gateway_0uysc4w.job.job_id
        and 
        job_a_report.job_id == Gateway_0uysc4w.iteration_index
        produces-outputs	Gateway_0uysc4w
        updates:
            Gateway_0uysc4w := Gateway_0uysc4w
            Gateway_0uysc4w.iteration_index := Gateway_0uysc4w.iteration_index + 1
        produces-outputs	temp_job_b_input
        references {
            x0: temp_job_b_input.input.list_of_key_value_pairs := temp_job_b_input.input.list_of_key_value_pairs
            x1: temp_job_b_input.input.list_of_key_value_pairs := <KeyValuePair[]>[
              KeyValuePair {
             key = "index__" + get(<string[]>["0","1","2","3"], Gateway_0uysc4w.iteration_index) + "__",
             value = job_a_report.some_value
              }
            ]
        } symbolic-link
        updates:
            temp_job_b_input := temp_job_b_input
            temp_job_b_input.iteration_index := Gateway_0uysc4w.iteration_index
        produces-outputs	job_a_report symbolic-link suppress
        updates:
            job_a_report := job_a_report
        
        action			JobBintake
        element-label	"Job B intake"
        case			default step-type "null" action-type COMPOSE
        with-inputs		jobB
        produces-outputs	Gateway_0uysc4w
        updates:
            Gateway_0uysc4w := ContextComposeJobB {
             iteration_index = 0,
             job = jobB
            }
        produces-outputs	temp_job_b_input symbolic-link
        updates:
            temp_job_b_input := TempInputJobB {
             iteration_index = 0,
             input = InputJobB {
              job_id = jobB.job_id,
              list_of_key_value_pairs = <KeyValuePair[]>[KeyValuePair {
                        key = "concrete",
                        value = "concreteValue"
                    }]
             }
            }
    
        element-labels ["Issue299", "C3", "Compose Job B"]
    }
    
    system Issue299C3RunJobB
    {
        inputs
        InputJobB	job_b_input
        
        outputs
        ReportJobB		job_b_report
    
        local
        
        UNIT	Event_18fn07m
    
        // init
    
    
        desc "Issue299C3Run Job B_Model"
        
        action			RunB
        element-label	"Run B"
        case			default step-type "BJob" action-type RUN
        with-inputs		job_b_input
        produces-outputs	Event_18fn07m suppress
        produces-outputs	job_b_report
        updates:
            job_b_report := ReportJobB { job_id = job_b_input.job_id }
    
        element-labels ["Issue299", "C3", "Run Job B"]
    }
    
    system Issue299C1
    {
        inputs
        Parameters	model_parameters
        
        outputs
        JobA		jobA
        JobB		jobB
    
        local
        ContextController	Gateway_0r5pxtv
        ContextController	Gateway_1habvb7
        
        ContextController	Event_0rch5hf
        ContextController	Flow_1ngqot2
    
        init
        model_parameters := Parameters {
         job_count = 2,
         job_tag = "some_job"
        }
    
    
        desc "Issue299C1_Model"
        
        action			DojobB
        element-label	"Do job B"
        case			default
        with-inputs		Flow_1ngqot2
        produces-outputs	Gateway_0r5pxtv
        updates:
            Gateway_0r5pxtv := Flow_1ngqot2
        produces-outputs	jobB
        updates:
            jobB := JobB {
             job_id = Flow_1ngqot2.job_index,
             some_label = Flow_1ngqot2.model_parameters.job_tag,
             count = Flow_1ngqot2.job_index
            }
        
        action			DojobA
        element-label	"Do job A"
        case			default
        with-inputs		Gateway_1habvb7
        produces-outputs	Flow_1ngqot2
        updates:
            Flow_1ngqot2 := Gateway_1habvb7
        produces-outputs	jobA
        updates:
            jobA := JobA { job_id = Gateway_1habvb7.job_index }
        
        action			Iterate
        element-label	"Iterate"
        case			default
        with-inputs		Gateway_0r5pxtv
        with-guard		Gateway_0r5pxtv.job_index < Gateway_0r5pxtv.model_parameters.job_count
        produces-outputs	Gateway_1habvb7
        updates:
            Gateway_1habvb7 := Gateway_0r5pxtv
            Gateway_1habvb7.job_index := Gateway_1habvb7.job_index + 1
        
        action			Initializecontroller
        element-label	"Initialize controller"
        case			default
        with-inputs		model_parameters
        produces-outputs	Gateway_1habvb7
        updates:
            Gateway_1habvb7 := ContextController {
             job_index = 0,
             model_parameters = model_parameters
            }
        
        action			Finish
        element-label	"Finish"
        case			default
        with-inputs		Gateway_0r5pxtv
        with-guard		Gateway_0r5pxtv.job_index >= Gateway_0r5pxtv.model_parameters.job_count
        produces-outputs	Event_0rch5hf
        updates:
            Event_0rch5hf := Gateway_0r5pxtv
    
        element-labels ["Issue299", "C1"]
    }
    
	SUT-blocks Issue299C2RunJobA Issue299C3RunJobB
	depth-limits 300
	num-tests 1
}
